---
# Automated service updates - Dynamic Version
- name: Check for service updates
  hosts: homelab
  gather_facts: yes
  become: yes

  vars:
    github_api_base: "https://api.github.com/repos"
    services:
      - name: "open-webui"
        github_repo: "open-webui/open-webui"
        docker_image: "ghcr.io/open-webui/open-webui"
        compose_service: "open-webui"
      - name: "n8n"
        github_repo: "n8nio/n8n"
        docker_image: "n8nio/n8n"
        compose_service: "n8n"
      - name: "ollama"
        github_repo: "ollama/ollama"
        docker_image: "ollama/ollama"
        compose_service: "ollama"
      - name: "coolify"
        github_repo: "coollabsio/coolify"
        docker_image: "coollabsio/coolify"
        compose_service: "coolify"

  tasks:
    - name: Read current docker-compose.yml
      slurp:
        src: "{{ docker_compose_file }}"
      register: compose_content

    - name: Parse docker-compose.yml content
      set_fact:
        compose_yaml: "{{ compose_content.content | b64decode | from_yaml }}"

    - name: Check for updates for each service
      uri:
        url: "{{ github_api_base }}/{{ item.github_repo }}/releases/latest"
        method: GET
        headers:
          User-Agent: "Homelab-Update-System"
        return_content: yes
      register: github_response
      loop: "{{ services }}"

    - name: Parse current and latest versions
      set_fact:
        service_updates: "{{ service_updates | default([]) + [item] }}"
      vars:
        item:
          name: "{{ item.item.name }}"
          github_repo: "{{ item.item.github_repo }}"
          docker_image: "{{ item.item.docker_image }}"
          compose_service: "{{ item.item.compose_service }}"
          current_version: "{{ compose_yaml.services[item.item.compose_service].image.split(':')[-1] }}"
          latest_version: "{{ item.json.tag_name }}"
          has_update: "{{ compose_yaml.services[item.item.compose_service].image.split(':')[-1] != item.json.tag_name }}"
      loop: "{{ github_response.results }}"

    - name: Display update status
      debug:
        msg: |
          {{ item.name }}: {{ item.current_version }} -> {{ item.latest_version }}
          Update available: {{ item.has_update }}
      loop: "{{ service_updates }}"

    - name: Update docker-compose.yml for services with updates
      replace:
        path: "{{ docker_compose_file }}"
        regexp: 'image: {{ item.docker_image }}:{{ item.current_version }}'
        replace: 'image: {{ item.docker_image }}:{{ item.latest_version }}'
      loop: "{{ service_updates }}"
      when: item.has_update

    - name: Pull updated images
      command: "docker pull {{ item.docker_image }}:{{ item.latest_version }}"
      loop: "{{ service_updates }}"
      when: item.has_update
      register: pull_results

    - name: Update and restart only updated services
      command: "docker-compose up -d {{ item.compose_service }}"
      loop: "{{ service_updates }}"
      when: item.has_update
      register: restart_results

    - name: Display update results
      debug:
        msg: |
          Updated {{ service_updates | selectattr('has_update') | list | length }} services:
          {% for service in service_updates %}
          {% if service.has_update %}
          - {{ service.name }}: {{ service.current_version }} -> {{ service.latest_version }}
          {% endif %}
          {% endfor %}

    - name: Clean up old images (only if updates occurred)
      command: "docker image prune -f"
      when: service_updates | selectattr('has_update') | list | length > 0
      register: cleanup_result

    - name: Display cleanup results
      debug:
        msg: "Cleaned up old images"
      when: service_updates | selectattr('has_update') | list | length > 0
